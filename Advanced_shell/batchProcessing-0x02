#!/bin/bash

# Batch Processing Script for Pokémon API Data Retrieval with Enhanced Error Handling
# File: batchProcessing-0x02
# Description: Fetches data for multiple Pokémon with retry logic and robust error handling

# API base URL
API_URL="https://pokeapi.co/api/v2/pokemon"

# List of Pokémon to fetch
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

# Output directory
OUTPUT_DIR="pokemon_data"

# Configuration
MAX_RETRIES=3
RETRY_DELAY=2
LOG_FILE="pokemon_fetch_errors.log"

# Create output directory if it doesn't exist
if [ ! -d "$OUTPUT_DIR" ]; then
    mkdir -p "$OUTPUT_DIR"
    echo "Created directory: $OUTPUT_DIR"
fi

# Initialize log file
echo "=== Pokémon Fetch Error Log - $(date) ===" > "$LOG_FILE"

# Function to log errors
log_error() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] ERROR: $message" >> "$LOG_FILE"
    echo "[$timestamp] ERROR: $message"
}

# Function to log info
log_info() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] INFO: $message" >> "$LOG_FILE"
}

# Function to validate Pokémon name
validate_pokemon_name() {
    local pokemon_name="$1"
    
    # Check if name contains only lowercase letters and hyphens
    if [[ ! "$pokemon_name" =~ ^[a-z-]+$ ]]; then
        return 1
    fi
    
    # Check minimum length
    if [ ${#pokemon_name} -lt 3 ]; then
        return 1
    fi
    
    return 0
}

# Function to check network connectivity
check_network() {
    if ! curl -s --connect-timeout 5 --max-time 10 "https://pokeapi.co" > /dev/null; then
        return 1
    fi
    return 0
}

# Enhanced function to fetch Pokémon data with retry logic
fetch_pokemon_data() {
    local pokemon_name="$1"
    local output_file="$OUTPUT_DIR/${pokemon_name}.json"
    local attempt=1
    
    # Validate Pokémon name
    if ! validate_pokemon_name "$pokemon_name"; then
        log_error "Invalid Pokémon name format: $pokemon_name"
        return 1
    fi
    
    echo "Fetching data for $pokemon_name..."
    log_info "Starting fetch for $pokemon_name"
    
    # Retry loop
    while [ $attempt -le $MAX_RETRIES ]; do
        echo "  Attempt $attempt/$MAX_RETRIES..."
        
        # Check network connectivity before attempting
        if ! check_network; then
            log_error "Network connectivity issue detected (attempt $attempt for $pokemon_name)"
            if [ $attempt -eq $MAX_RETRIES ]; then
                echo "  ❌ Network connectivity failed after $MAX_RETRIES attempts"
                return 1
            fi
            echo "  ⚠️  Network issue, retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
            ((attempt++))
            continue
        fi
        
        # Make API request with timeout and error handling
        local http_code
        http_code=$(curl -s -w "%{http_code}" -o "$output_file" \
                   --connect-timeout 10 \
                   --max-time 30 \
                   --retry 0 \
                   "$API_URL/$pokemon_name")
        
        local curl_exit_code=$?
        
        # Check curl exit code
        if [ $curl_exit_code -ne 0 ]; then
            case $curl_exit_code in
                6)  log_error "Could not resolve host (attempt $attempt for $pokemon_name)" ;;
                7)  log_error "Failed to connect to host (attempt $attempt for $pokemon_name)" ;;
                28) log_error "Operation timeout (attempt $attempt for $pokemon_name)" ;;
                *)  log_error "Curl error code $curl_exit_code (attempt $attempt for $pokemon_name)" ;;
            esac
        # Check HTTP status code
        elif [ "$http_code" = "404" ]; then
            log_error "Pokémon '$pokemon_name' not found (HTTP 404)"
            rm -f "$output_file"
            echo "  ❌ Pokémon '$pokemon_name' not found"
            return 1
        elif [ "$http_code" = "429" ]; then
            log_error "Rate limit exceeded (HTTP 429) (attempt $attempt for $pokemon_name)"
            echo "  ⚠️  Rate limit exceeded, waiting longer..."
            sleep $((RETRY_DELAY * 2))
        elif [[ "$http_code" =~ ^[45][0-9][0-9]$ ]]; then
            log_error "HTTP error $http_code (attempt $attempt for $pokemon_name)"
        elif [ "$http_code" = "200" ]; then
            # Check if the file was created and contains valid JSON
            if [ -s "$output_file" ] && jq empty "$output_file" 2>/dev/null; then
                echo "  ✅ Saved data to $output_file"
                log_info "Successfully fetched $pokemon_name on attempt $attempt"
                return 0
            else
                log_error "Invalid JSON received (attempt $attempt for $pokemon_name)"
                rm -f "$output_file"
            fi
        else
            log_error "Unexpected HTTP code $http_code (attempt $attempt for $pokemon_name)"
        fi
        
        # If this was the last attempt, give up
        if [ $attempt -eq $MAX_RETRIES ]; then
            echo "  ❌ Failed to fetch $pokemon_name after $MAX_RETRIES attempts"
            log_error "Giving up on $pokemon_name after $MAX_RETRIES attempts"
            rm -f "$output_file"
            return 1
        fi
        
        # Wait before retrying
        echo "  ⚠️  Retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY
        ((attempt++))
    done
    
    return 1
}

# Main execution
echo "Starting batch processing of ${#POKEMON_LIST[@]} Pokémon..."
echo "Output directory: $OUTPUT_DIR"
echo "Rate limiting: 1 second delay between requests"
echo "Max retries per Pokémon: $MAX_RETRIES"
echo "Error log: $LOG_FILE"
echo

successful_count=0
failed_count=0

# Process each Pokémon
for pokemon in "${POKEMON_LIST[@]}"; do
    if fetch_pokemon_data "$pokemon"; then
        ((successful_count++))
    else
        ((failed_count++))
    fi
    
    # Add delay to respect rate limiting (except for the last request)
    if [ "$pokemon" != "${POKEMON_LIST[-1]}" ]; then
        echo "Waiting 1 second..."
        sleep 1
    fi
    echo
done

# Summary
echo "=== BATCH PROCESSING COMPLETE ==="
echo "Total Pokémon processed: ${#POKEMON_LIST[@]}"
echo "Successful: $successful_count"
echo "Failed: $failed_count"
echo "Output directory: $OUTPUT_DIR"
echo "Error log: $LOG_FILE"

# Log final summary
log_info "Batch processing complete: $successful_count successful, $failed_count failed"

if [ $failed_count -gt 0 ]; then
    echo "⚠️  Some requests failed. Check the error log: $LOG_FILE"
    echo "Failed Pokémon files (if any) have been removed from $OUTPUT_DIR"
    exit 1
else
    echo "✅ All Pokémon data retrieved successfully!"
    exit 0
fi